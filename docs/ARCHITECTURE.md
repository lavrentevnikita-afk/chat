# Архитектура — Team Messenger (прототип)

Цель: дать ясную картину компонентов, потоков данных и границ ответственности для команды разработки.

Компоненты
- Client (Web / Mobile)
  - UI: чат, список задач, создание/обновление задач
  - Auth: хранит JWT в памяти/secure storage
  - Подключается к REST API и Socket.IO для реального времени

- Backend (ASGI)
  - REST API (CRUD задач, аутентификация)
  - Socket.IO (push событий: новые сообщения, задачи)
  - Сервисный слой: бизнес-логика вынесена из обработчиков
  - Persistence: SQL через SQLAlchemy

- Database
  - PostgreSQL в проде, SQLite для локального dev

Взаимодействия (последовательность)
1. Клиент логинится через `/v1/auth/login` → получает JWT
2. Клиент открывает Socket.IO с передачей JWT (в параметре запроса или через заголовок)
3. Backend валидирует JWT и присоединяет пользователя к комнате (например `user:{id}` и `global`)
4. При создании задачи через REST `/v1/tasks` backend сохраняет задачу и эмитит `task_created` в соответствующие комнаты (assigned_to и глобальную)
5. Клиенты получают событие и обновляют UI

Схема ролей и прав
- user: может создавать/обновлять свои задачи, просматривать задачи, где он назначен
- manager: может назначать задачи другим
- admin: полные права

Нефункциональные требования
- Масштабируемость: Socket.IO узлы + Redis Pub/Sub (для многопроцессной/многосерверной работы)
- Безопасность: TLS, проверка токенов, шифрование секретов
- Логирование и мониторинг: structured logs + Prometheus (метрики)

Паттерны реализации
- Слой сервисов: контроллеры (роуты) вызывают сервисы, которые транзакционно работают с репозиториями
- Репозитории: инкапсулируют SQLAlchemy сессии
- Миграции: Alembic

Пример папки `backend/app`
```
app/
├─ main.py           # FastAPI + Socket.IO init
├─ api/
│  ├─ deps.py        # зависимости (get_db, current_user)
│  └─ v1/
│     ├─ auth.py
│     ├─ tasks.py
│     └─ messages.py
├─ core/
│  ├─ config.py
│  └─ security.py
├─ models.py
├─ schemas.py
├─ crud.py
└─ services/
   ├─ message_service.py
   └─ task_service.py
```

Диаграмма потоков (текст)
Client (web/mobile) -> HTTP (REST) -> Backend -> DB
Client (web/mobile) -> Socket.IO -> Backend -> Backend emits events -> Clients

Заключение
Архитектура модульна: можно постепенно добавлять авторизацию, масштабирование через Redis, мониторинг и CI/CD. После утверждения подготовлю готовую структуру и минимальную реализацию API и фронтенда.
